<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="pragma" content="no-cache"/>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <meta charset="utf-8"/>
    <title>Crypto Bowl</title>
    <script>
    // Clear ALL localStorage for fresh start and patch save detection
    (function() {
        var version = 'cb_v4';
        if (localStorage.getItem('_cb_ver') !== version) {
            localStorage.clear();
            localStorage.setItem('_cb_ver', version);
            console.log('Cleared ALL localStorage for fresh start (v4)');
        }

        // Patch localStorage.getItem to return null for empty/corrupt save files
        var originalGetItem = localStorage.getItem.bind(localStorage);
        localStorage.getItem = function(key) {
            var value = originalGetItem(key);
            // If it's a save-related key and value is empty/whitespace only, return null
            if (key && key.indexOf('.save') !== -1 || key && key.indexOf('.option') !== -1 || key && key.indexOf('.uniform') !== -1) {
                if (!value || value.trim() === '') {
                    return null;
                }
            }
            return value;
        };

        // Patch XMLHttpRequest to return 404 for save files (prevent serve -s from faking them)
        var originalXHROpen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function(method, url) {
            this._cbUrl = url;
            return originalXHROpen.apply(this, arguments);
        };
        var originalXHRSend = XMLHttpRequest.prototype.send;
        XMLHttpRequest.prototype.send = function() {
            if (this._cbUrl && (this._cbUrl.indexOf('savedata') !== -1 || this._cbUrl.indexOf('optiondata') !== -1 || this._cbUrl.indexOf('uniforms_custom') !== -1)) {
                // Fake a 404 for save files
                var self = this;
                setTimeout(function() {
                    Object.defineProperty(self, 'status', { value: 404, writable: false });
                    Object.defineProperty(self, 'readyState', { value: 4, writable: false });
                    if (self.onreadystatechange) self.onreadystatechange();
                    if (self.onload) self.onload();
                }, 0);
                return;
            }
            return originalXHRSend.apply(this, arguments);
        };
    })();
    </script>
    <style>
        body { background: #000; margin: 0; padding: 0; }
        canvas { image-rendering: optimizeSpeed; -ms-touch-action: none; margin: 0; padding: 0; }
    </style>
</head>
<body>
    <div id="gm4html5_div_id">
        <img src="html5game/splash.png" id="GM4HTML5_loadingscreen" style="display:none;"/>
        <canvas id="canvas" width="853" height="480">
            <p>Your browser doesn't support HTML5 canvas.</p>
        </canvas>
    </div>

    <script>
    // Poki SDK stubs - so game runs without Poki
    window.poki_init_raw = function() { return false; };
    window.poki_gameplay_start = function() {};
    window.poki_gameplay_stop = function() {};
    window.poki_commercial_break = function(cb) { if(cb) cb(true); };
    window.poki_rewarded_break = function(cb) { if(cb) cb(true); };
    window.cpd = function() { return false; };
    window.PokiSDK = null;
    </script>

    <script type="text/javascript" src="html5game/RetroBowl.js"></script>

    <script>
    window.addEventListener("load", function() {
        window.PokiSDK_loadState = 0;
        window.PokiSDK_OK = false;
        GameMaker_Init();
    });

    // Re-enable right-click after 3 seconds
    setTimeout(function() {
        document.body.oncontextmenu = null;
    }, 3000);
    </script>
</body>
</html>
